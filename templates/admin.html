<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SilverMail Live Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .log-console {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.75rem;
        }
        /* Custom scrollbar for logs */
        .log-console::-webkit-scrollbar { width: 8px; }
        .log-console::-webkit-scrollbar-track { background: #1e1e1e; }
        .log-console::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .log-console::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-3">
                    <i data-lucide="shield" class="h-6 w-6 text-blue-600"></i>
                    <h1 class="text-xl font-bold text-gray-800">SilverMail <span class="text-xs font-normal text-gray-500 ml-2">Admin Dashboard</span></h1>
                    <span class="flex h-3 w-3 relative ml-4">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    <span class="text-xs text-green-600 font-semibold">LIVE</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" target="_blank" class="text-gray-500 hover:text-blue-600 flex items-center text-sm transition">
                        <i data-lucide="external-link" class="w-4 h-4 mr-1"></i> Public View
                    </a>
                    <a href="/temp/logout" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm font-medium transition shadow-sm">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Active Users</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1" id="total-users">0</p>
                </div>
                <div class="p-3 rounded-full bg-blue-50 text-blue-600">
                    <i data-lucide="users" class="w-6 h-6"></i>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">System Status</p>
                    <p class="text-lg font-bold text-green-600 mt-1">Operational</p>
                </div>
                <div class="p-3 rounded-full bg-green-50 text-green-600">
                    <i data-lucide="activity" class="w-6 h-6"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden flex flex-col h-[600px]">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h3 class="font-semibold text-gray-700 flex items-center">
                        <i data-lucide="inbox" class="w-4 h-4 mr-2"></i> Recent Sessions
                    </h3>
                    <span class="text-xs text-gray-400" id="last-updated-users">Updating...</span>
                </div>
                
                <div class="overflow-y-auto flex-1">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User / Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Inbox</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100" id="users-table-body">
                            <tr>
                                <td colspan="3" class="px-6 py-10 text-center text-gray-400">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-[#1e1e1e] shadow-lg rounded-xl overflow-hidden flex flex-col h-[600px] border border-gray-700">
                <div class="px-4 py-3 bg-[#2d2d2d] border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-xs font-medium text-gray-300 flex items-center uppercase tracking-wide">
                        <i data-lucide="terminal" class="w-3 h-3 mr-2 text-green-400"></i> System Logs
                    </h3>
                    <div class="flex items-center space-x-2">
                        <label class="flex items-center text-xs text-gray-400 cursor-pointer hover:text-white">
                            <input type="checkbox" id="auto-scroll" checked class="mr-1 accent-green-500 rounded text-xs"> Auto-scroll
                        </label>
                    </div>
                </div>
                <div class="p-4 flex-1 overflow-y-auto log-console" id="log-container">
                    <div class="text-gray-500 italic">Waiting for logs stream...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();
        const usersTableBody = document.getElementById('users-table-body');
        const logContainer = document.getElementById('log-container');
        const totalUsersEl = document.getElementById('total-users');
        const lastUpdatedEl = document.getElementById('last-updated-users');
        const autoScrollCheck = document.getElementById('auto-scroll');

        // Fungsi Format Tanggal
        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return date.toLocaleDateString();
        }

        async function fetchDashboardData() {
            try {
                const response = await fetch('/api/admin/data');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                renderUsers(data.stats);
                renderLogs(data.logs);

                // Update timestamps
                const now = new Date();
                lastUpdatedEl.textContent = "Last update: " + now.toLocaleTimeString();

            } catch (error) {
                console.error('Error fetching data:', error);
                lastUpdatedEl.textContent = "Connection lost. Retrying...";
                lastUpdatedEl.classList.add('text-red-500');
            }
        }

        function renderUsers(users) {
            totalUsersEl.textContent = users.length;
            
            if (users.length === 0) {
                usersTableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-8 text-center text-gray-400">No active sessions yet.</td></tr>`;
                return;
            }

            // Rebuild table rows
            let html = '';
            users.forEach(user => {
                // Badge Logic
                let badgeClass = user.inbox_count > 0 
                    ? 'bg-green-100 text-green-800 ring-green-600/20' 
                    : 'bg-gray-100 text-gray-600 ring-gray-500/10';
                
                let rowClass = user.inbox_count > 0 ? 'bg-green-50/30' : '';

                html += `
                    <tr class="hover:bg-gray-50 transition duration-150 ${rowClass}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs uppercase border border-blue-200">
                                    ${user.email.substring(0, 2)}
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm font-medium text-gray-900">${user.email}</div>
                                    <div class="text-xs text-gray-400">${user.ip_address}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${timeAgo(user.created_at)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ${badgeClass}">
                                ${user.inbox_count} Msgs
                            </span>
                        </td>
                    </tr>
                `;
            });
            usersTableBody.innerHTML = html;
        }

        function renderLogs(logs) {
            if (!logs || logs.length === 0) return;
            
            // Log logic: simple replace content
            const logHtml = logs.map(line => {
                // Highlight keywords
                let styledLine = line
                    .replace(/\[ERROR\]/g, '<span class="text-red-500 font-bold">[ERROR]</span>')
                    .replace(/\[SMTP\]/g, '<span class="text-blue-400 font-bold">[SMTP]</span>')
                    .replace(/Starting/g, '<span class="text-yellow-300">Starting</span>');
                return `<div class="mb-1 border-b border-gray-800 pb-1 hover:bg-white/5">${styledLine}</div>`;
            }).join('');

            // Only update if content changed to avoid jitter (simple check)
            if (logContainer.innerHTML !== logHtml) {
                logContainer.innerHTML = logHtml;
                // Auto scroll to bottom
                if (autoScrollCheck.checked) {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            }
        }

        // --- Init ---
        fetchDashboardData(); // First load
        
        // Auto Refresh every 3 seconds
        setInterval(fetchDashboardData, 3000);

    </script>
</body>
</html>