<!doctype html>
<html lang="en" class="h-full antialiased selection:bg-zinc-900 selection:text-white">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>SilverMail - Privacy First</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    },
                    colors: {
                        border: "hsl(var(--border))", input: "hsl(var(--input))", ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))", foreground: "hsl(var(--foreground))",
                        primary: { DEFAULT: "hsl(var(--primary))", foreground: "hsl(var(--primary-foreground))" },
                        secondary: { DEFAULT: "hsl(var(--secondary))", foreground: "hsl(var(--secondary-foreground))" },
                        muted: { DEFAULT: "hsl(var(--muted))", foreground: "hsl(var(--muted-foreground))" },
                        card: { DEFAULT: "hsl(var(--card))", foreground: "hsl(var(--card-foreground))" },
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --background: 0 0% 100%; --foreground: 240 10% 3.9%; 
            --card: 0 0% 100%; --card-foreground: 240 10% 3.9%;
            --primary: 240 5.9% 10%; --primary-foreground: 0 0% 98%;
            --secondary: 240 4.8% 95.9%; --secondary-foreground: 240 5.9% 10%;
            --muted: 240 4.8% 95.9%; --muted-foreground: 240 3.8% 46.1%;
            --border: 240 5.9% 90%; --input: 240 5.9% 90%; --ring: 240 5.9% 10%;
        }
        body { background-color: #f4f4f5; } /* Zinc-100 */
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #e4e4e7; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #d4d4d8; }
    </style>
</head>

<body class="text-zinc-900 min-h-screen flex flex-col font-sans">

    <header class="sticky top-0 z-50 w-full border-b border-zinc-200 bg-white/80 backdrop-blur-md">
        <div class="container max-w-3xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-zinc-900 text-white p-1.5 rounded-lg">
                    <i data-lucide="mail" class="h-5 w-5"></i>
                </div>
                <span class="font-bold tracking-tight text-lg">SilverMail</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-xs font-medium px-2.5 py-1 rounded-full bg-green-100 text-green-700 flex items-center gap-1.5">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    Online
                </span>
            </div>
        </div>
    </header>

    <main class="flex-1 container max-w-3xl mx-auto px-4 py-8 space-y-6">
        
        <div class="rounded-2xl border border-zinc-200 bg-white shadow-sm p-6 animate-slide-up" style="animation-delay: 0s;">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold tracking-tight">Create Identity</h2>
                    <p class="text-sm text-zinc-500">Choose a custom username or let us generate one.</p>
                </div>
                <button id="btn-reset" class="text-zinc-400 hover:text-red-500 transition-colors p-2 rounded-md hover:bg-zinc-100" title="Reset Session">
                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-12 gap-3">
                <div class="sm:col-span-5">
                    <div class="relative">
                        <i data-lucide="user" class="absolute left-3 top-2.5 h-4 w-4 text-zinc-400"></i>
                        <input id="username" placeholder="random (optional)" class="pl-9 flex h-10 w-full rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm placeholder:text-zinc-400 focus:outline-none focus:ring-2 focus:ring-zinc-900 focus:border-transparent transition-all">
                    </div>
                </div>
                <div class="sm:col-span-4">
                    <div class="relative">
                        <i data-lucide="globe" class="absolute left-3 top-2.5 h-4 w-4 text-zinc-400"></i>
                        <select id="domain" class="pl-9 flex h-10 w-full rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-zinc-900 focus:border-transparent transition-all appearance-none">
                            {% for domain in domains %}
                            <option value="{{ domain }}">@{{ domain }}</option>
                            {% endfor %}
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-3 h-3 w-3 text-zinc-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="sm:col-span-3">
                    <button id="btn-create" class="flex w-full items-center justify-center h-10 rounded-lg bg-zinc-900 text-sm font-medium text-white hover:bg-zinc-800 focus:outline-none focus:ring-2 focus:ring-zinc-900 focus:ring-offset-2 transition-all">
                        <i data-lucide="sparkles" class="mr-2 h-4 w-4"></i> Generate
                    </button>
                </div>
            </div>
        </div>

        <div id="active-email-container" class="hidden rounded-2xl border border-blue-100 bg-blue-50/50 p-6 animate-slide-up shadow-sm relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <i data-lucide="mail-open" class="h-24 w-24 text-blue-600"></i>
            </div>
            
            <div class="relative z-10">
                <p class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-1">Active Inbox</p>
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 justify-between">
                    <div>
                        <h1 id="display-email" class="text-2xl sm:text-3xl font-bold text-zinc-900 tracking-tight break-all">...</h1>
                        <p id="display-name" class="text-sm text-zinc-500 font-medium mt-1">
                            Hi, <span id="name-text">User</span>! Waiting for messages...
                        </p>
                    </div>
                    <button onclick="copyEmailMain()" id="btn-copy-main" class="flex items-center justify-center gap-2 bg-white border border-blue-200 text-blue-700 hover:bg-blue-100 hover:border-blue-300 px-5 py-2.5 rounded-xl font-semibold shadow-sm transition-all active:scale-95">
                        <i data-lucide="copy" class="h-4 w-4"></i> <span id="copy-text-main">Copy Address</span>
                    </button>
                </div>
                
                <div class="mt-6 flex items-center gap-3 text-xs text-blue-400 font-medium">
                    <div class="h-1 flex-1 bg-blue-200 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-1000 ease-linear" style="width: 100%"></div>
                    </div>
                    <span id="timer-display">5s</span>
                </div>
            </div>
        </div>

        <div class="space-y-4 animate-slide-up" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between px-1">
                <h3 class="font-bold text-lg text-zinc-800 flex items-center gap-2">
                    <i data-lucide="inbox" class="h-5 w-5 text-zinc-500"></i> Inbox
                </h3>
                <span id="email-counter" class="bg-zinc-100 text-zinc-600 px-3 py-1 rounded-full text-xs font-bold border border-zinc-200">
                    0 Messages
                </span>
            </div>

            <div id="inbox-container" class="space-y-3 min-h-[300px]">
                <div id="empty-state" class="flex flex-col items-center justify-center py-20 text-center border-2 border-dashed border-zinc-200 rounded-2xl bg-zinc-50/50">
                    <div class="bg-white p-4 rounded-full shadow-sm mb-4">
                        <i data-lucide="ghost" class="h-8 w-8 text-zinc-300"></i>
                    </div>
                    <h3 class="font-medium text-zinc-900">Inbox Empty</h3>
                    <p class="text-sm text-zinc-500 mt-1">Emails will appear here automatically.</p>
                </div>
            </div>
        </div>

    </main>

    <footer class="mt-auto py-8 text-center border-t border-zinc-200 bg-white">
        <div class="container mx-auto px-4">
            <a href="https://github.com/swwillbemine/SilverMail-MultiPlatform" target="_blank" class="inline-flex items-center gap-2 text-sm font-medium text-zinc-400 hover:text-zinc-900 transition-colors group">
                <i data-lucide="github" class="h-4 w-4 group-hover:scale-110 transition-transform"></i>
                Created <Wbr></Wbr>ith ❤️ for Silver Wolf
            </a>
        </div>
    </footer>

    <div id="toast" class="fixed bottom-6 right-6 z-[100] translate-y-[150%] transition-transform duration-300 ease-out">
        <div class="bg-zinc-900 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 min-w-[320px] border border-zinc-700/50">
            <div id="toast-icon-bg" class="p-1 rounded-full bg-green-500/20 text-green-400">
                <i data-lucide="check" class="h-4 w-4"></i>
            </div>
            <div>
                <h4 id="toast-title" class="text-sm font-bold">Success</h4>
                <p id="toast-message" class="text-xs text-zinc-400">Action completed successfully.</p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const state = {
            email: "{{ email if email else '' }}",
            refreshInterval: 5000,
            fetchTimeout: null,
            countDownInterval: null,
            storedEmails: [],
            timeLeft: 5
        };

        const els = {
            btnCreate: document.getElementById('btn-create'),
            btnReset: document.getElementById('btn-reset'),
            containerActive: document.getElementById('active-email-container'),
            displayEmail: document.getElementById('display-email'),
            displayName: document.getElementById('display-name'),
            nameText: document.getElementById('name-text'),
            inboxContainer: document.getElementById('inbox-container'),
            emptyState: document.getElementById('empty-state'),
            counter: document.getElementById('email-counter'),
            usernameInput: document.getElementById('username'),
            domainInput: document.getElementById('domain'),
            timerDisplay: document.getElementById('timer-display'),
            progressBar: document.getElementById('progress-bar'),
            toast: document.getElementById('toast')
        };

        // --- API & Core Functions ---

        async function createEmail() {
            setLoading(true);
            try {
                const username = els.usernameInput.value.trim();
                const domain = els.domainInput.value;
                
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, domain })
                });

                if (!res.ok) throw new Error('Failed to generate');
                const data = await res.json();
                
                if (data.email) {
                    state.email = data.email;
                    updateActiveEmailUI(data.email, data.fullName);
                    showToast('Identity Created', `Ready: ${data.email}`);
                    resetInbox();
                    startPolling();
                }
            } catch (err) {
                showToast('Error', 'Could not generate email', true);
            } finally {
                setLoading(false);
            }
        }

        async function fetchEmails() {
            if (!state.email) return;

            try {
                const res = await fetch('/emails');
                const emails = await res.json();
                
                if (emails.length > state.storedEmails.length) {
                    const newCount = emails.length - state.storedEmails.length;
                    showToast('New Message', `${newCount} email(s) received`);
                    // Optional: Audio play here
                }

                // Render if changed
                if (JSON.stringify(emails) !== JSON.stringify(state.storedEmails)) {
                   renderInbox(emails);
                   state.storedEmails = emails;
                }

            } catch (err) {
                console.error("Polling error", err);
            } finally {
                resetTimer();
            }
        }

        // --- Render Logic (The Critical Part) ---

        function renderInbox(emails) {
            if (!emails || emails.length === 0) {
                if (!document.getElementById('empty-state')) resetInbox();
                return;
            }

            els.counter.textContent = `${emails.length} Messages`;
            els.inboxContainer.innerHTML = '';
            
            emails.slice().reverse().forEach((email, index) => {
                try {
                    // 1. ROBUST DATA MAPPING
                    const sender = email.sender || email.from || 'Unknown Sender';
                    const dateRaw = email.received_at || email.date || new Date().toISOString();
                    const subject = email.subject || '(No Subject)';
                    const body = email.body || '';

                    // 2. SMART OTP EXTRACTION
                    // Prioritas: Cari angka 4-8 digit. Jika tidak ada, ambil kata pertama.
                    const otpRegex = /\b\d{4,8}\b/;
                    const match = subject.match(otpRegex) || body.match(otpRegex);
                    const otpCode = match ? match[0] : subject.trim().split(/\s+/)[0];

                    // 3. Date Formatting
                    let dateDisplay = 'Just now';
                    try {
                        const d = new Date(dateRaw);
                        if(!isNaN(d)) dateDisplay = new Intl.DateTimeFormat('en-US', {hour:'numeric', minute:'numeric', hour12:true}).format(d);
                    } catch(e){}

                    // 4. Create Card HTML
                    const card = document.createElement('div');
                    card.className = "bg-white border border-zinc-200 rounded-xl overflow-hidden hover:shadow-md hover:border-zinc-300 transition-all cursor-pointer group animate-fade-in";
                    
                    card.innerHTML = `
                        <div class="p-4" onclick="toggleBody(this)">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="h-6 w-6 rounded-full bg-zinc-100 flex items-center justify-center text-xs font-bold text-zinc-500">
                                            ${sender.charAt(0).toUpperCase()}
                                        </div>
                                        <p class="text-sm font-semibold text-zinc-900 truncate">${escapeHtml(sender)}</p>
                                    </div>
                                    <h4 class="text-sm font-medium text-zinc-700 truncate pr-2">${escapeHtml(subject)}</h4>
                                </div>
                                <span class="text-xs text-zinc-400 whitespace-nowrap">${dateDisplay}</span>
                            </div>

                            <div class="flex items-center gap-2 mt-3">
                                <button onclick="event.stopPropagation(); performCopy('${otpCode}', this)" 
                                        class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-zinc-50 border border-zinc-200 text-xs font-medium text-zinc-600 hover:bg-zinc-100 hover:text-zinc-900 transition-colors"
                                        title="Copy Code/First Word">
                                    <i data-lucide="key" class="h-3 w-3"></i> 
                                    <span>Code: ${otpCode.substring(0,6)}${otpCode.length>6?'...':''}</span>
                                </button>
                                
                                <button onclick="event.stopPropagation(); performCopy('${escapeJs(subject)}', this)" 
                                        class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-zinc-50 border border-zinc-200 text-xs font-medium text-zinc-600 hover:bg-zinc-100 hover:text-zinc-900 transition-colors">
                                    <i data-lucide="type" class="h-3 w-3"></i> Subject
                                </button>
                            </div>
                        </div>
                        
                        <div class="hidden bg-zinc-50/50 border-t border-zinc-100 p-4 text-sm text-zinc-600 font-mono break-words">
                            ${escapeHtml(body)}
                        </div>
                    `;
                    els.inboxContainer.appendChild(card);
                } catch(err) {
                    console.error("Render Item Error", err);
                }
            });
            lucide.createIcons();
        }

        // --- Helper Functions ---

        function toggleBody(header) {
            const body = header.nextElementSibling;
            // Tutup yang lain (Accordion style) - Optional, hilangkan baris ini jika ingin multi-open
            // document.querySelectorAll('.bg-zinc-50\\/50').forEach(el => { if(el !== body) el.classList.add('hidden'); });
            body.classList.toggle('hidden');
        }

        function resetTimer() {
            if (state.fetchTimeout) clearTimeout(state.fetchTimeout);
            state.timeLeft = state.refreshInterval / 1000;
            updateTimerUI();
            state.fetchTimeout = setTimeout(fetchEmails, state.refreshInterval);
        }

        function startPolling() {
            if (state.fetchTimeout) clearTimeout(state.fetchTimeout);
            if (state.countDownInterval) clearInterval(state.countDownInterval);
            
            fetchEmails(); // Initial fetch
            
            state.countDownInterval = setInterval(() => {
                if (state.timeLeft > 0) {
                    state.timeLeft--;
                    updateTimerUI();
                }
            }, 1000);
        }

        function updateTimerUI() {
            els.timerDisplay.textContent = `${state.timeLeft}s`;
            const percentage = (state.timeLeft / (state.refreshInterval/1000)) * 100;
            els.progressBar.style.width = `${percentage}%`;
        }

        // --- HTTP-SAFE COPY FUNCTION ---
        function performCopy(text, btnElement) {
            if(!text) return;
            text = text.trim();

            // Fallback Logic
            const copyLogic = (txt) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    return navigator.clipboard.writeText(txt);
                } else {
                    return new Promise((resolve, reject) => {
                        try {
                            const ta = document.createElement('textarea');
                            ta.value = txt;
                            ta.style.position='fixed'; ta.style.left='-9999px';
                            document.body.appendChild(ta);
                            ta.select();
                            document.execCommand('copy');
                            document.body.removeChild(ta);
                            resolve();
                        } catch(e) { reject(e); }
                    });
                }
            };

            copyLogic(text).then(() => {
                // UI Feedback
                const originalContent = btnElement.innerHTML;
                btnElement.innerHTML = `<i data-lucide="check" class="h-3 w-3 text-green-600"></i> <span class="text-green-600">Copied</span>`;
                lucide.createIcons();
                showToast('Copied', `Copied to clipboard`);
                
                setTimeout(() => {
                    btnElement.innerHTML = originalContent;
                    lucide.createIcons();
                }, 2000);
            }).catch(() => showToast('Error', 'Copy failed manually', true));
        }

        function copyEmailMain() {
            performCopy(els.displayEmail.textContent, document.getElementById('btn-copy-main'));
        }

        // --- UI Utilities ---

        function updateActiveEmailUI(email, name) {
            els.containerActive.classList.remove('hidden');
            els.displayEmail.textContent = email;
            els.nameText.textContent = name || 'Friend';
            if(window.innerWidth < 768) els.containerActive.scrollIntoView({ behavior: 'smooth' });
        }

        function resetInbox() {
            els.inboxContainer.innerHTML = '';
            els.inboxContainer.appendChild(els.emptyState);
            els.counter.textContent = '0 Messages';
            state.storedEmails = [];
            state.timeLeft = 5;
            updateTimerUI();
        }

        function setLoading(isLoading) {
            const btn = els.btnCreate;
            if(isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin h-4 w-4 mr-2"></i> Creating...`;
            } else {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="sparkles" class="h-4 w-4 mr-2"></i> Generate`;
            }
            lucide.createIcons();
        }

        function showToast(title, msg, isError=false) {
            const toast = els.toast;
            const iconBg = document.getElementById('toast-icon-bg');
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = msg;

            if(isError) {
                iconBg.className = "p-1 rounded-full bg-red-500/20 text-red-400";
                iconBg.innerHTML = `<i data-lucide="alert-triangle" class="h-4 w-4"></i>`;
            } else {
                iconBg.className = "p-1 rounded-full bg-green-500/20 text-green-400";
                iconBg.innerHTML = `<i data-lucide="check" class="h-4 w-4"></i>`;
            }
            lucide.createIcons();
            
            toast.classList.remove('translate-y-[150%]');
            setTimeout(() => toast.classList.add('translate-y-[150%]'), 3000);
        }

        function escapeHtml(text) { return text ? String(text).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]; }) : ''; }
        function escapeJs(text) { return text ? String(text).replace(/'/g, "\\'") : ''; }

        // --- Init ---
        els.btnCreate.addEventListener('click', createEmail);
        els.btnReset.addEventListener('click', () => {
            state.email = null;
            if(state.fetchTimeout) clearTimeout(state.fetchTimeout);
            if(state.countDownInterval) clearInterval(state.countDownInterval);
            els.containerActive.classList.add('hidden');
            resetInbox();
            showToast('Reset', 'Session cleared');
        });

        if (state.email) {
            updateActiveEmailUI(state.email, 'User');
            startPolling();
        }
    </script>
</body>
</html>